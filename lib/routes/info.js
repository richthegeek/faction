// Generated by CoffeeScript 1.6.3
var Cache;

Cache = require('shared-cache');

module.exports = function(server) {
  return server.post('/info/:info-type', Info_Model.route, function(req, res, next) {
    var mappings;
    mappings = Cache.create('info-mappings-' + req.account.data._id, true, function(key, next) {
      return new Infomapping_Model(req.account, function() {
        return this.table.find().toArray(next);
      });
    });
    return req.model.create(req.params['info-type'], req.body, function(err) {
      if (err) {
        throw err;
      }
      return mappings.get(function(err, list, hit) {
        var mapping;
        return res.send({
          status: 'ok',
          statusText: 'Information recieved',
          mappings: (function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = list.length; _i < _len; _i++) {
              mapping = list[_i];
              if (mapping.info_type === req.params['info-type']) {
                _results.push(Infomapping_Model["export"](mapping));
              }
            }
            return _results;
          })()
        });
      });
    });
  });
};
